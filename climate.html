<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AVA Climate Detail</title>
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  <link rel="stylesheet" href="./css/climate.css" />
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="breadcrumb">
        <a href="./index.html">← Back to map</a>
        <span id="crumbAva" class="badge">AVA</span>
      </div>

      <div class="unit-toggle">
        <button id="unitMetric" class="toggle-btn active" type="button">°C / mm</button>
        <button id="unitImperial" class="toggle-btn" type="button">°F / in</button>
      </div>
    </div>

    <div class="header">
      <div>
        <h1 id="title">Climate detail</h1>
        <div class="subtitle">
          <span id="metaAvaId" class="badge">ava_id: —</span>
          <span id="metaPeriod" class="badge" style="margin-left:8px;">period: —</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Overview</h2>
        <p class="notice" id="overviewNote">Loading CSV…</p>

        <div class="stats">
          <div class="stat">
            <div class="label">Avg Temp (all months)</div>
            <div id="kpi_tmean" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Avg Temp (summer)</div>
            <div id="kpi_tsummer" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Avg Monthly Precip</div>
            <div id="kpi_ppt" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Data coverage</div>
            <div id="kpi_cov" class="value">—</div>
          </div>
        </div>

        <p class="small" id="kpiFoot" style="margin-top:10px;">
          These are computed directly from <code>ava_prism_monthly_stats.csv</code>.
        </p>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div>
            <h2 style="margin-bottom:4px;">Climate view</h2>
            <p class="notice" id="viewNote" style="margin:0;">Choose a view to explore the data.</p>
          </div>
      
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="small">View</span>
            <select id="viewSelect" class="select">
              <option value="monthly" selected>Monthly normals</option>
              <option value="yearly">Yearly averages</option>
            </select>
      
            <span class="small" style="margin-left:6px;">Metric</span>
            <select id="seriesSelect" class="select">
              <option value="tmean" selected>Temperature</option>
              <option value="ppt">Precipitation</option>
            </select>
          </div>
        </div>
      
        <!-- YEARLY CHART -->
        <div id="yearlySection" style="display:none; margin-top:14px;">
          <p class="notice" id="yearlyNote">Computing yearly averages…</p>
          <div class="canvas-wrap">
            <canvas id="yearlyCanvas" width="1000" height="420"></canvas>
          </div>
          <p class="small" id="yearlyRange"></p>
        </div>
      
        <!-- MONTHLY TABLE -->
        <div id="monthlySection" style="margin-top:14px;">
          <p class="notice" id="monthlyNote">Computing monthly averages…</p>
      
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Temp mean</th>
                  <th>Temp min</th>
                  <th>Temp max</th>
                  <th>Precip mean</th>
                  <th>Precip min</th>
                  <th>Precip max</th>
                </tr>
              </thead>
              <tbody id="monthlyBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------- utils ----------------
    const $ = (id) => document.getElementById(id);
    const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function cToF(c) { return (c * 9) / 5 + 32; }
    function mmToIn(mm) { return mm / 25.4; }

    function fmt(n, digits=1) {
      if (n === null || n === undefined || Number.isNaN(n)) return "—";
      return Number(n).toFixed(digits);
    }

    // Fast CSV parse for simple, comma-separated data (no quoted commas)
    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(",").map(s => s.trim());
      return lines
        .filter(l => l.trim().length)
        .map(line => {
          const cols = line.split(","); // safe for your file (no quoted commas)
          const row = {};
          header.forEach((h, i) => row[h] = cols[i]);
          return row;
        });
    }

    function ymToYearMonth(ym) {
      // ym like 198101
      const s = String(ym);
      const year = Number(s.slice(0,4));
      const month = Number(s.slice(4,6)); // 1..12
      return { year, month };
    }

    // ---------------- state ----------------
    let unitMode = "metric";
    const avaId = getParam("ava_id");
    const nameFromUrl = getParam("name");
    const periodFromUrl = getParam("period");

    $("metaAvaId").textContent = `ava_id: ${avaId ?? "—"}`;
    $("metaPeriod").textContent = `period: ${periodFromUrl ?? "—"}`;
    $("title").textContent = nameFromUrl ? `Climate: ${nameFromUrl}` : "Climate detail";
    $("crumbAva").textContent = nameFromUrl ? nameFromUrl : "AVA";

    function setUnit(mode) {
      unitMode = mode;
      $("unitMetric")?.classList.toggle("active", mode === "metric");
      $("unitImperial")?.classList.toggle("active", mode === "imperial");

      if (window.__derived) renderAll(window.__derived);
    }
    $("unitMetric")?.addEventListener("click", () => setUnit("metric"));
    $("unitImperial")?.addEventListener("click", () => setUnit("imperial"));

    // ---------------- compute derived views ----------------
  function computeDerived(rows) {
    // Parse rows into numeric monthly records
    const parsed = rows.map(r => {
      const { year, month } = ymToYearMonth(r.ym);
      return {
        ava_id: r.ava_id,
        name: r.name,
        year,
        month,
        tmean_mean: Number(r.tmean_mean),
        tmean_min:  Number(r.tmean_min),
        tmean_max:  Number(r.tmean_max),
        ppt_mean:   Number(r.ppt_mean),
        ppt_min:    Number(r.ppt_min),
        ppt_max:    Number(r.ppt_max)
      };
    });
  
    const years = parsed.map(r => r.year);
    const minYear = Math.min(...years);
    const maxYear = Math.max(...years);
  
    // ---- Monthly normals (Jan–Dec averages across years)
    const byMonth = new Map();
    for (const r of parsed) {
      if (!byMonth.has(r.month)) {
        byMonth.set(r.month, {
          month: r.month,
          n: 0,
          tmean_mean: 0,
          tmean_min: 0,
          tmean_max: 0,
          ppt_mean: 0,
          ppt_min: 0,
          ppt_max: 0
        });
      }
      const a = byMonth.get(r.month);
      a.n++;
      a.tmean_mean += r.tmean_mean;
      a.tmean_min  += r.tmean_min;
      a.tmean_max  += r.tmean_max;
      a.ppt_mean   += r.ppt_mean;
      a.ppt_min    += r.ppt_min;
      a.ppt_max    += r.ppt_max;
    }
  
    const monthly = [];
    for (let m = 1; m <= 12; m++) {
      const a = byMonth.get(m);
      if (!a) {
        monthly.push({ month: m, n: 0 });
        continue;
      }
      monthly.push({
        month: m,
        n: a.n,
        tmean_mean: a.tmean_mean / a.n,
        tmean_min:  a.tmean_min  / a.n,
        tmean_max:  a.tmean_max  / a.n,
        ppt_mean:   a.ppt_mean   / a.n,
        ppt_min:    a.ppt_min    / a.n,
        ppt_max:    a.ppt_max    / a.n
      });
    }
  
    // ---- KPIs
    const avg = arr => arr.reduce((s,v)=>s+v,0) / (arr.length || 1);
    const tmeanAll = avg(parsed.map(r => r.tmean_mean));
    const tmeanSummer = avg(parsed.filter(r => [6,7,8].includes(r.month)).map(r => r.tmean_mean));
    const pptMonthly = avg(parsed.map(r => r.ppt_mean));
  
    return {
      ava_id: parsed[0]?.ava_id ?? avaId,
      name: parsed[0]?.name ?? nameFromUrl ?? "",
      minYear,
      maxYear,
      count: parsed.length,
      parsed,
      monthly,
      kpis: { tmeanAll, tmeanSummer, pptMonthly }
    };
  }


    function computeYearly(parsedRows) {
      // parsedRows are the numeric rows (with year/month numbers) for this AVA
      const byYear = new Map(); // year -> accum
    
      for (const r of parsedRows) {
        if (!byYear.has(r.year)) {
          byYear.set(r.year, { year: r.year, n: 0, tmean: 0, ppt: 0 });
        }
        const a = byYear.get(r.year);
        a.n += 1;
        a.tmean += r.tmean_mean;  // monthly mean temp
        a.ppt += r.ppt_mean;      // monthly mean precip
      }
    
      const years = [...byYear.keys()].sort((a,b)=>a-b);
    
      // Yearly avg temp = average of monthly means
      // Yearly precip: you can choose SUM (total annual) or AVG (avg monthly)
      // Usually better: SUM for annual precip.
      const series = years.map(y => {
        const a = byYear.get(y);
        return {
          year: y,
          tmean_c: a.tmean / a.n,
          ppt_mm_annual: a.ppt,           // SUM of monthly means -> annual total (mm)
          ppt_mm_monthly_avg: a.ppt / a.n // avg monthly precip (mm)
        };
      });
    
      return series;
    }


    // ---------------- render ----------------
    function renderAll(d) {
      const metric = unitMode === "metric";

      // Update header (if CSV has canonical name)
      if (d.name) {
        $("title").textContent = `Climate: ${d.name}`;
        $("crumbAva").textContent = d.name;
      }
      $("metaAvaId").textContent = `ava_id: ${d.ava_id ?? "—"}`;
      $("metaPeriod").textContent = `period: ${d.minYear}–${d.maxYear}`;

      const tAll = metric ? d.kpis.tmeanAll : cToF(d.kpis.tmeanAll);
      const tSummer = metric ? d.kpis.tmeanSummer : cToF(d.kpis.tmeanSummer);
      const ppt = metric ? d.kpis.pptMonthly : mmToIn(d.kpis.pptMonthly);

      $("kpi_tmean").textContent = `${fmt(tAll, 1)} ${metric ? "°C" : "°F"}`;
      $("kpi_tsummer").textContent = `${fmt(tSummer, 1)} ${metric ? "°C" : "°F"}`;
      $("kpi_ppt").textContent = `${fmt(ppt, metric ? 0 : 2)} ${metric ? "mm" : "in"}`;
      $("kpi_cov").textContent = `${d.minYear}–${d.maxYear}`;

      $("overviewNote").textContent =
        `Rows: ${d.count.toLocaleString()} monthly records. Period: ${d.minYear}–${d.maxYear}.`;

      // Monthly table
      const body = $("monthlyBody");
      body.innerHTML = "";

      for (const r of d.monthly) {
        const m = r.month;
        const tmean = metric ? r.tmean_mean : cToF(r.tmean_mean);
        const tmin  = metric ? r.tmean_min  : cToF(r.tmean_min);
        const tmax  = metric ? r.tmean_max  : cToF(r.tmean_max);
        const pmean = metric ? r.ppt_mean   : mmToIn(r.ppt_mean);
        const pmin  = metric ? r.ppt_min    : mmToIn(r.ppt_min);
        const pmax  = metric ? r.ppt_max    : mmToIn(r.ppt_max);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${MONTHS[m-1]}</td>
          <td>${fmt(tmean, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(tmin, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(tmax, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(pmean, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
          <td>${fmt(pmin, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
          <td>${fmt(pmax, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
        `;
        body.appendChild(tr);
      }

      $("monthlyNote").textContent = "Monthly normals computed by averaging each month across all years.";
      applyView();
    }

    // ---------------- load ----------------
    async function init() {
      if (!avaId) {
        $("overviewNote").textContent = "No ava_id provided. Go back to the map and click an AVA.";
        $("monthlyNote").textContent = "No AVA selected.";
        return;
      }

      try {
        const res = await fetch("./assets/data/ava_prism_monthly_stats.csv");
        if (!res.ok) throw new Error("CSV fetch failed: " + res.status);
        const text = await res.text();
        const all = parseCsv(text);

        const rows = all.filter(r => String(r.ava_id) === String(avaId));
        if (!rows.length) {
          $("overviewNote").textContent = "No rows found for this ava_id in the CSV.";
          $("monthlyNote").textContent = "Nothing to display.";
          return;
        }

        const derived = computeDerived(rows);
        derived.yearly = computeYearly(derived.parsed);
        window.__derived = derived;
        renderAll(derived);
      } catch (e) {
        console.warn(e);
        $("overviewNote").textContent = "Failed to load / parse CSV. Check console.";
        $("monthlyNote").textContent = "Failed to load.";
      }
    }

    const viewSelect = document.getElementById("viewSelect");
    const seriesSelect = document.getElementById("seriesSelect");
    
    function applyView() {
      const view = viewSelect.value;
      const series = seriesSelect.value;
    
      const monthlySection = document.getElementById("monthlySection");
      const yearlySection = document.getElementById("yearlySection");
    
      if (!window.__derived) return;
    
      if (view === "yearly") {
        monthlySection.style.display = "none";
        yearlySection.style.display = "block";
    
        const d = window.__derived;
        const metric = unitMode === "metric";
        const canvas = document.getElementById("yearlyCanvas");
    
        // Build points
        let points = [];
        let title = "";
    
        if (series === "tmean") {
          points = d.yearly.map(r => ({
            x: r.year,
            y: metric ? r.tmean_c : cToF(r.tmean_c)
          }));
          title = `Yearly avg temperature (${metric ? "°C" : "°F"})`;
          document.getElementById("yearlyNote").textContent = "Each point is the yearly average of monthly mean temperature.";
          document.getElementById("yearlyRange").textContent = `${d.minYear}–${d.maxYear}`;
          drawLineChart(canvas, points, { title, yDigits: 1 });
        } else {
          // Precip: use annual total (sum of monthly means)
          points = d.yearly.map(r => ({
            x: r.year,
            y: metric ? r.ppt_mm_annual : mmToIn(r.ppt_mm_annual)
          }));
          title = `Yearly total precipitation (${metric ? "mm" : "in"})`;
          document.getElementById("yearlyNote").textContent = "Each point is the annual total (sum across months).";
          document.getElementById("yearlyRange").textContent = `${d.minYear}–${d.maxYear}`;
          drawLineChart(canvas, points, { title, yDigits: metric ? 0 : 1 });
        }
    
      } else {
        yearlySection.style.display = "none";
        monthlySection.style.display = "block";
      }
    }
    
    viewSelect?.addEventListener("change", applyView);
    seriesSelect?.addEventListener("change", applyView);


    function drawLineChart(canvas, points, opts) {
      const ctx = canvas.getContext("2d");
      const W = canvas.width, H = canvas.height;
    
      // Clear
      ctx.clearRect(0, 0, W, H);
    
      const padL = 56, padR = 18, padT = 18, padB = 42;
      const plotW = W - padL - padR;
      const plotH = H - padT - padB;
    
      const xs = points.map(p => p.x);
      const ys = points.map(p => p.y);
    
      const xMin = Math.min(...xs), xMax = Math.max(...xs);
      let yMin = Math.min(...ys), yMax = Math.max(...ys);
    
      // Add a little padding to y range
      const yPad = (yMax - yMin) * 0.08 || 1;
      yMin -= yPad;
      yMax += yPad;
    
      const xToPx = (x) => padL + ((x - xMin) / (xMax - xMin || 1)) * plotW;
      const yToPx = (y) => padT + (1 - ((y - yMin) / (yMax - yMin || 1))) * plotH;
    
      // Background grid
      ctx.globalAlpha = 1;
      ctx.lineWidth = 1;
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.fillStyle = "rgba(255,255,255,0.75)";
      ctx.font = "12px system-ui";
    
      // Y grid (5 lines)
      const steps = 5;
      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const yVal = yMin + (1 - t) * (yMax - yMin);
        const yPx = padT + t * plotH;
    
        ctx.beginPath();
        ctx.moveTo(padL, yPx);
        ctx.lineTo(W - padR, yPx);
        ctx.stroke();
    
        ctx.fillText(yVal.toFixed(opts.yDigits ?? 1), 8, yPx + 4);
      }
    
      // X labels: start + end + a few in between
      ctx.fillStyle = "rgba(255,255,255,0.65)";
      const xLabels = [xMin, xMax];
      const mid1 = Math.round(xMin + (xMax - xMin) * 0.33);
      const mid2 = Math.round(xMin + (xMax - xMin) * 0.66);
      xLabels.splice(1, 0, mid1, mid2);
    
      for (const x of xLabels) {
        const xPx = xToPx(x);
        ctx.fillText(String(x), xPx - 12, H - 16);
      }
    
      // Line
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(124,92,255,0.95)";
      ctx.beginPath();
      points.forEach((p, i) => {
        const px = xToPx(p.x);
        const py = yToPx(p.y);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      });
      ctx.stroke();
    
      // Title
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.font = "13px system-ui";
      ctx.fillText(opts.title ?? "", padL, 16);
    }

    init();
  </script>
</body>
</html>
