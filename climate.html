<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AVA Climate Detail</title>
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  <link rel="stylesheet" href="./css/climate.css" />
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="breadcrumb">
        <a href="./index.html">← Back to map</a>
        <span id="crumbAva" class="badge">AVA</span>
      </div>

      <div class="unit-toggle">
        <button id="unitMetric" class="toggle-btn active" type="button">°C / mm</button>
        <button id="unitImperial" class="toggle-btn" type="button">°F / in</button>
      </div>
    </div>

    <div class="header">
      <div>
        <h1 id="title">Climate detail</h1>
        <div class="subtitle">
          <span id="metaAvaId" class="badge">ava_id: —</span>
          <span id="metaPeriod" class="badge" style="margin-left:8px;">period: —</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Overview</h2>
        <p class="notice" id="overviewNote">Loading CSV…</p>

        <div class="stats">
          <div class="stat">
            <div class="label">Avg Temp (all months)</div>
            <div id="kpi_tmean" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Avg Temp (summer)</div>
            <div id="kpi_tsummer" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Avg Monthly Precip</div>
            <div id="kpi_ppt" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Data coverage</div>
            <div id="kpi_cov" class="value">—</div>
          </div>
        </div>

        <p class="small" id="kpiFoot" style="margin-top:10px;">
          These are computed directly from <code>ava_prism_monthly_stats.csv</code>.
        </p>
      </div>

      <div class="card">
        <h2>Monthly normals (across all years)</h2>
        <p class="notice" id="monthlyNote">Computing monthly averages…</p>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Temp mean</th>
                <th>Temp min</th>
                <th>Temp max</th>
                <th>Precip mean</th>
                <th>Precip min</th>
                <th>Precip max</th>
              </tr>
            </thead>
            <tbody id="monthlyBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------- utils ----------------
    const $ = (id) => document.getElementById(id);
    const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function cToF(c) { return (c * 9) / 5 + 32; }
    function mmToIn(mm) { return mm / 25.4; }

    function fmt(n, digits=1) {
      if (n === null || n === undefined || Number.isNaN(n)) return "—";
      return Number(n).toFixed(digits);
    }

    // Fast CSV parse for simple, comma-separated data (no quoted commas)
    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(",").map(s => s.trim());
      return lines
        .filter(l => l.trim().length)
        .map(line => {
          const cols = line.split(","); // safe for your file (no quoted commas)
          const row = {};
          header.forEach((h, i) => row[h] = cols[i]);
          return row;
        });
    }

    function ymToYearMonth(ym) {
      // ym like 198101
      const s = String(ym);
      const year = Number(s.slice(0,4));
      const month = Number(s.slice(4,6)); // 1..12
      return { year, month };
    }

    // ---------------- state ----------------
    let unitMode = "metric";
    const avaId = getParam("ava_id");
    const nameFromUrl = getParam("name");
    const periodFromUrl = getParam("period");

    $("metaAvaId").textContent = `ava_id: ${avaId ?? "—"}`;
    $("metaPeriod").textContent = `period: ${periodFromUrl ?? "—"}`;
    $("title").textContent = nameFromUrl ? `Climate: ${nameFromUrl}` : "Climate detail";
    $("crumbAva").textContent = nameFromUrl ? nameFromUrl : "AVA";

    function setUnit(mode) {
      unitMode = mode;
      $("unitMetric")?.classList.toggle("active", mode === "metric");
      $("unitImperial")?.classList.toggle("active", mode === "imperial");

      if (window.__derived) renderAll(window.__derived);
    }
    $("unitMetric")?.addEventListener("click", () => setUnit("metric"));
    $("unitImperial")?.addEventListener("click", () => setUnit("imperial"));

    // ---------------- compute derived views ----------------
    function computeDerived(rows) {
      // rows = filtered rows for this AVA
      // numeric columns
      const parsed = rows.map(r => {
        const { year, month } = ymToYearMonth(r.ym);
        return {
          ava_id: r.ava_id,
          name: r.name,
          year,
          month,
          tmean_mean: Number(r.tmean_mean),
          tmean_min:  Number(r.tmean_min),
          tmean_max:  Number(r.tmean_max),
          ppt_mean:   Number(r.ppt_mean),
          ppt_min:    Number(r.ppt_min),
          ppt_max:    Number(r.ppt_max),
        };
      });

      const years = parsed.map(r => r.year);
      const minYear = Math.min(...years);
      const maxYear = Math.max(...years);

      // Monthly normals: group by month across all years
      const byMonth = new Map(); // month -> accum
      for (const r of parsed) {
        if (!byMonth.has(r.month)) {
          byMonth.set(r.month, {
            month: r.month,
            n: 0,
            tmean_mean: 0, tmean_min: 0, tmean_max: 0,
            ppt_mean: 0, ppt_min: 0, ppt_max: 0,
          });
        }
        const a = byMonth.get(r.month);
        a.n += 1;
        a.tmean_mean += r.tmean_mean;
        a.tmean_min  += r.tmean_min;
        a.tmean_max  += r.tmean_max;
        a.ppt_mean   += r.ppt_mean;
        a.ppt_min    += r.ppt_min;
        a.ppt_max    += r.ppt_max;
      }

      const monthly = [];
      for (let m = 1; m <= 12; m++) {
        const a = byMonth.get(m);
        if (!a || a.n === 0) {
          monthly.push({ month: m, n: 0 });
          continue;
        }
        monthly.push({
          month: m,
          n: a.n,
          tmean_mean: a.tmean_mean / a.n,
          tmean_min:  a.tmean_min  / a.n,
          tmean_max:  a.tmean_max  / a.n,
          ppt_mean:   a.ppt_mean   / a.n,
          ppt_min:    a.ppt_min    / a.n,
          ppt_max:    a.ppt_max    / a.n,
        });
      }

      // KPIs
      const avg = (arr) => arr.reduce((s,v)=>s+v,0) / (arr.length || 1);

      const tmeanAll = avg(parsed.map(r => r.tmean_mean));
      const summerMonths = new Set([6,7,8]); // Jun Jul Aug
      const tmeanSummer = avg(parsed.filter(r => summerMonths.has(r.month)).map(r => r.tmean_mean));
      const pptMonthly = avg(parsed.map(r => r.ppt_mean));

      return {
        ava_id: parsed[0]?.ava_id ?? avaId,
        name: parsed[0]?.name ?? nameFromUrl ?? "",
        minYear, maxYear,
        count: parsed.length,
        monthly,
        kpis: { tmeanAll, tmeanSummer, pptMonthly }
      };
    }

    // ---------------- render ----------------
    function renderAll(d) {
      const metric = unitMode === "metric";

      // Update header (if CSV has canonical name)
      if (d.name) {
        $("title").textContent = `Climate: ${d.name}`;
        $("crumbAva").textContent = d.name;
      }
      $("metaAvaId").textContent = `ava_id: ${d.ava_id ?? "—"}`;
      $("metaPeriod").textContent = `period: ${d.minYear}–${d.maxYear}`;

      const tAll = metric ? d.kpis.tmeanAll : cToF(d.kpis.tmeanAll);
      const tSummer = metric ? d.kpis.tmeanSummer : cToF(d.kpis.tmeanSummer);
      const ppt = metric ? d.kpis.pptMonthly : mmToIn(d.kpis.pptMonthly);

      $("kpi_tmean").textContent = `${fmt(tAll, 1)} ${metric ? "°C" : "°F"}`;
      $("kpi_tsummer").textContent = `${fmt(tSummer, 1)} ${metric ? "°C" : "°F"}`;
      $("kpi_ppt").textContent = `${fmt(ppt, metric ? 0 : 2)} ${metric ? "mm" : "in"}`;
      $("kpi_cov").textContent = `${d.minYear}–${d.maxYear}`;

      $("overviewNote").textContent =
        `Rows: ${d.count.toLocaleString()} monthly records. Period: ${d.minYear}–${d.maxYear}.`;

      // Monthly table
      const body = $("monthlyBody");
      body.innerHTML = "";

      for (const r of d.monthly) {
        const m = r.month;
        const tmean = metric ? r.tmean_mean : cToF(r.tmean_mean);
        const tmin  = metric ? r.tmean_min  : cToF(r.tmean_min);
        const tmax  = metric ? r.tmean_max  : cToF(r.tmean_max);
        const pmean = metric ? r.ppt_mean   : mmToIn(r.ppt_mean);
        const pmin  = metric ? r.ppt_min    : mmToIn(r.ppt_min);
        const pmax  = metric ? r.ppt_max    : mmToIn(r.ppt_max);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${MONTHS[m-1]}</td>
          <td>${fmt(tmean, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(tmin, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(tmax, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(pmean, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
          <td>${fmt(pmin, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
          <td>${fmt(pmax, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
        `;
        body.appendChild(tr);
      }

      $("monthlyNote").textContent = "Monthly normals computed by averaging each month across all years.";
    }

    // ---------------- load ----------------
    async function init() {
      if (!avaId) {
        $("overviewNote").textContent = "No ava_id provided. Go back to the map and click an AVA.";
        $("monthlyNote").textContent = "No AVA selected.";
        return;
      }

      try {
        const res = await fetch("./assets/data/ava_prism_monthly_stats.csv");
        if (!res.ok) throw new Error("CSV fetch failed: " + res.status);
        const text = await res.text();
        const all = parseCsv(text);

        const rows = all.filter(r => String(r.ava_id) === String(avaId));
        if (!rows.length) {
          $("overviewNote").textContent = "No rows found for this ava_id in the CSV.";
          $("monthlyNote").textContent = "Nothing to display.";
          return;
        }

        const derived = computeDerived(rows);
        window.__derived = derived;
        renderAll(derived);
      } catch (e) {
        console.warn(e);
        $("overviewNote").textContent = "Failed to load / parse CSV. Check console.";
        $("monthlyNote").textContent = "Failed to load.";
      }
    }

    init();
  </script>
</body>
</html>
