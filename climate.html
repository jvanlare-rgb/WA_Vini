<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AVA Climate Detail</title>
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  <link rel="stylesheet" href="./css/climate.css" />
</head>

<body>
  <div class="container">

    <!-- Top bar -->
    <div class="topbar">
      <div class="breadcrumb">
        <a href="./index.html">← Back to map</a>
        <span id="crumbAva" class="badge">AVA</span>
      </div>

      <div class="unit-toggle">
        <button id="unitMetric" class="toggle-btn active" type="button">°C / mm</button>
        <button id="unitImperial" class="toggle-btn" type="button">°F / in</button>
      </div>
    </div>

    <!-- Header -->
    <div class="header">
      <div>
        <h1 id="title">Climate detail</h1>
        <div class="subtitle">
          <span id="metaAvaId" class="badge">ava_id: —</span>
          <span id="metaPeriod" class="badge" style="margin-left:8px;">period: —</span>
        </div>
      </div>
    </div>

    <div class="grid">

      <!-- Overview KPI card -->
      <div class="card">
        <h2>Overview</h2>
        <p class="notice" id="overviewNote">Loading CSV…</p>

        <div class="stats">
          <div class="stat">
            <div class="label">Avg Temp (all months)</div>
            <div id="kpi_tmean" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Avg Temp (summer)</div>
            <div id="kpi_tsummer" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Avg Monthly Precip</div>
            <div id="kpi_ppt" class="value">—</div>
          </div>
          <div class="stat">
            <div class="label">Data coverage</div>
            <div id="kpi_cov" class="value">—</div>
          </div>
        </div>

        <p class="small" style="margin-top:10px;">
          These are computed directly from <code>ava_prism_monthly_stats.csv</code>.
        </p>
      </div>

      <!-- Monthly normals table (static: no dropdown) -->
      <div class="card">
        <div class="card-header-row">
          <div>
            <h2 style="margin:0;">Monthly normals</h2>
            <p class="notice" id="monthlyNote" style="margin:8px 0 0 0;">
              Computing monthly averages…
            </p>
          </div>
        </div>

        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Temp mean</th>
                <th>Temp min</th>
                <th>Temp max</th>
                <th>Precip mean</th>
                <th>Precip min</th>
                <th>Precip max</th>
              </tr>
            </thead>
            <tbody id="monthlyBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Visuals section -->
      <div class="card">
        <div class="card-header-row">
          <div>
            <h2 style="margin:0;">Visuals</h2>
            <p class="notice" id="visualNote" style="margin:8px 0 0 0;">
              Yearly view shows annual precipitation totals and yearly average temperature.
            </p>
          </div>

          <div class="controls">
            <span class="small">View</span>
            <select id="chartSelect" class="select">
              <option value="yearly" selected>Yearly</option>
              <option value="1">Jan</option>
              <option value="2">Feb</option>
              <option value="3">Mar</option>
              <option value="4">Apr</option>
              <option value="5">May</option>
              <option value="6">Jun</option>
              <option value="7">Jul</option>
              <option value="8">Aug</option>
              <option value="9">Sep</option>
              <option value="10">Oct</option>
              <option value="11">Nov</option>
              <option value="12">Dec</option>
            </select>
          </div>
        </div>

        <div class="charts-grid" style="margin-top:12px;">
          <div class="chart-card">
            <div class="chart-title" id="tempChartTitle">Temperature</div>
            <div class="canvas-wrap">
              <canvas id="tempCanvas" width="900" height="420"></canvas>
            </div>
            <div class="chart-sub" id="tempChartSub">—</div>
          </div>

          <div class="chart-card">
            <div class="chart-title" id="pptChartTitle">Precipitation</div>
            <div class="canvas-wrap">
              <canvas id="pptCanvas" width="900" height="420"></canvas>
            </div>
            <div class="chart-sub" id="pptChartSub">—</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ---------------- utils ----------------
    const $ = (id) => document.getElementById(id);
    const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function cToF(c) { return (c * 9) / 5 + 32; }
    function mmToIn(mm) { return mm / 25.4; }

    function fmt(n, digits=1) {
      if (n === null || n === undefined || Number.isNaN(n)) return "—";
      return Number(n).toFixed(digits);
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(",").map(s => s.trim());
      return lines
        .filter(l => l.trim().length)
        .map(line => {
          const cols = line.split(",");
          const row = {};
          header.forEach((h, i) => row[h] = cols[i]);
          return row;
        });
    }

    function ymToYearMonth(ym) {
      const s = String(ym);
      const year = Number(s.slice(0, 4));
      const month = Number(s.slice(4, 6));
      return { year, month };
    }

    // ---------------- state ----------------
    let unitMode = "metric"; // metric or imperial

    const avaId = getParam("ava_id");
    const nameFromUrl = getParam("name");
    const periodFromUrl = getParam("period");

    $("metaAvaId").textContent = `ava_id: ${avaId ?? "—"}`;
    $("metaPeriod").textContent = `period: ${periodFromUrl ?? "—"}`;
    $("title").textContent = nameFromUrl ? `Climate: ${nameFromUrl}` : "Climate detail";
    $("crumbAva").textContent = nameFromUrl ? nameFromUrl : "AVA";

    function setUnit(mode) {
      unitMode = mode;
      $("unitMetric")?.classList.toggle("active", mode === "metric");
      $("unitImperial")?.classList.toggle("active", mode === "imperial");
      if (window.__derived) renderAll(window.__derived);
    }
    $("unitMetric")?.addEventListener("click", () => setUnit("metric"));
    $("unitImperial")?.addEventListener("click", () => setUnit("imperial"));

    // ---------------- compute derived views ----------------
    function computeDerived(rows) {
      const parsed = rows.map(r => {
        const { year, month } = ymToYearMonth(r.ym);
        return {
          ava_id: r.ava_id,
          name: r.name,
          year,
          month,
          tmean_mean: Number(r.tmean_mean),
          tmean_min:  Number(r.tmean_min),
          tmean_max:  Number(r.tmean_max),
          ppt_mean:   Number(r.ppt_mean),
          ppt_min:    Number(r.ppt_min),
          ppt_max:    Number(r.ppt_max)
        };
      });

      const years = parsed.map(r => r.year);
      const minYear = Math.min(...years);
      const maxYear = Math.max(...years);

      // Monthly normals (mean of each month across years)
      const byMonth = new Map();
      for (const r of parsed) {
        if (!byMonth.has(r.month)) {
          byMonth.set(r.month, {
            month: r.month,
            n: 0,
            tmean_mean: 0, tmean_min: 0, tmean_max: 0,
            ppt_mean: 0,   ppt_min: 0,   ppt_max: 0
          });
        }
        const a = byMonth.get(r.month);
        a.n++;
        a.tmean_mean += r.tmean_mean;
        a.tmean_min  += r.tmean_min;
        a.tmean_max  += r.tmean_max;
        a.ppt_mean   += r.ppt_mean;
        a.ppt_min    += r.ppt_min;
        a.ppt_max    += r.ppt_max;
      }

      const monthly = [];
      for (let m = 1; m <= 12; m++) {
        const a = byMonth.get(m);
        if (!a) {
          monthly.push({ month: m, n: 0 });
          continue;
        }
        monthly.push({
          month: m,
          n: a.n,
          tmean_mean: a.tmean_mean / a.n,
          tmean_min:  a.tmean_min  / a.n,
          tmean_max:  a.tmean_max  / a.n,
          ppt_mean:   a.ppt_mean   / a.n,
          ppt_min:    a.ppt_min    / a.n,
          ppt_max:    a.ppt_max    / a.n
        });
      }

      // KPIs
      const avg = (arr) => arr.reduce((s,v)=>s+v,0) / (arr.length || 1);
      const tmeanAll = avg(parsed.map(r => r.tmean_mean));
      const tmeanSummer = avg(parsed.filter(r => [6,7,8].includes(r.month)).map(r => r.tmean_mean));
      const pptMonthly = avg(parsed.map(r => r.ppt_mean));

      return {
        ava_id: parsed[0]?.ava_id ?? avaId,
        name: parsed[0]?.name ?? nameFromUrl ?? "",
        minYear,
        maxYear,
        count: parsed.length,
        parsed,
        monthly,
        kpis: { tmeanAll, tmeanSummer, pptMonthly }
      };
    }

    function computeYearly(parsedRows) {
      const byYear = new Map();
      for (const r of parsedRows) {
        if (!byYear.has(r.year)) {
          byYear.set(r.year, { year: r.year, n: 0, tmean_sum: 0, ppt_sum: 0 });
        }
        const a = byYear.get(r.year);
        a.n++;
        a.tmean_sum += r.tmean_mean; // avg temp = mean of monthly means
        a.ppt_sum += r.ppt_mean;     // annual precip total = sum of monthly means
      }

      const years = [...byYear.keys()].sort((a,b)=>a-b);
      return years.map(y => {
        const a = byYear.get(y);
        return {
          year: y,
          tmean_c: a.tmean_sum / a.n,
          ppt_mm_annual: a.ppt_sum
        };
      });
    }

    function computeMonthSeries(parsedRows) {
      // month -> [{year, tmean_c, ppt_mm}]
      const map = new Map();
      for (let m = 1; m <= 12; m++) map.set(m, []);

      for (const r of parsedRows) {
        map.get(r.month).push({
          year: r.year,
          tmean_c: r.tmean_mean,
          ppt_mm: r.ppt_mean
        });
      }

      // sort each month by year
      for (let m = 1; m <= 12; m++) {
        map.get(m).sort((a,b)=>a.year-b.year);
      }
      return map;
    }

    // ---------------- charts ----------------
    function drawLineChart(canvas, points, opts) {
      const ctx = canvas.getContext("2d");
      const W = canvas.width, H = canvas.height;

      ctx.clearRect(0, 0, W, H);

      const padL = 56, padR = 18, padT = 22, padB = 44;
      const plotW = W - padL - padR;
      const plotH = H - padT - padB;

      if (!points.length) return;

      const xs = points.map(p => p.x);
      const ys = points.map(p => p.y);

      const xMin = Math.min(...xs), xMax = Math.max(...xs);
      let yMin = Math.min(...ys), yMax = Math.max(...ys);

      const yPad = (yMax - yMin) * 0.08 || 1;
      yMin -= yPad;
      yMax += yPad;

      const xToPx = (x) => padL + ((x - xMin) / (xMax - xMin || 1)) * plotW;
      const yToPx = (y) => padT + (1 - ((y - yMin) / (yMax - yMin || 1))) * plotH;

      // grid + y labels
      ctx.lineWidth = 1;
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.fillStyle = "rgba(255,255,255,0.70)";
      ctx.font = "12px system-ui";

      const steps = 5;
      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const yVal = yMin + (1 - t) * (yMax - yMin);
        const yPx = padT + t * plotH;

        ctx.beginPath();
        ctx.moveTo(padL, yPx);
        ctx.lineTo(W - padR, yPx);
        ctx.stroke();

        ctx.fillText(yVal.toFixed(opts.yDigits ?? 1), 8, yPx + 4);
      }

      // x labels
      ctx.fillStyle = "rgba(255,255,255,0.60)";
      const xLabels = [xMin, xMax];
      const mid1 = Math.round(xMin + (xMax - xMin) * 0.33);
      const mid2 = Math.round(xMin + (xMax - xMin) * 0.66);
      xLabels.splice(1, 0, mid1, mid2);

      for (const x of xLabels) {
        const xPx = xToPx(x);
        ctx.fillText(String(x), xPx - 12, H - 16);
      }

      // line
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(124,92,255,0.95)";
      ctx.beginPath();
      points.forEach((p, i) => {
        const px = xToPx(p.x);
        const py = yToPx(p.y);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      });
      ctx.stroke();

      // title
      ctx.fillStyle = "rgba(255,255,255,0.86)";
      ctx.font = "13px system-ui";
      ctx.fillText(opts.title ?? "", padL, 16);
    }

    function renderCharts(d) {
      const metric = unitMode === "metric";
      const sel = $("chartSelect").value;

      const tempCanvas = $("tempCanvas");
      const pptCanvas = $("pptCanvas");

      if (sel === "yearly") {
        $("visualNote").textContent = "Yearly view shows annual precipitation totals and yearly average temperature.";
        $("tempChartTitle").textContent = "Temperature (yearly average)";
        $("pptChartTitle").textContent = "Precipitation (annual total)";

        const tempPoints = d.yearly.map(r => ({
          x: r.year,
          y: metric ? r.tmean_c : cToF(r.tmean_c)
        }));
        const pptPoints = d.yearly.map(r => ({
          x: r.year,
          y: metric ? r.ppt_mm_annual : mmToIn(r.ppt_mm_annual)
        }));

        $("tempChartSub").textContent = `${d.minYear}–${d.maxYear}`;
        $("pptChartSub").textContent = `${d.minYear}–${d.maxYear}`;

        drawLineChart(tempCanvas, tempPoints, {
          title: `Yearly avg temp (${metric ? "°C" : "°F"})`,
          yDigits: 1
        });

        drawLineChart(pptCanvas, pptPoints, {
          title: `Annual precip (${metric ? "mm" : "in"})`,
          yDigits: metric ? 0 : 1
        });

        return;
      }

      // Month selection (1..12): show that month across years
      const m = Number(sel);
      const monthName = MONTHS[m - 1];

      $("visualNote").textContent = `${monthName} view shows that month’s values across years.`;
      $("tempChartTitle").textContent = `Temperature (${monthName})`;
      $("pptChartTitle").textContent = `Precipitation (${monthName})`;

      const series = d.monthSeries.get(m) || [];

      const tempPoints = series.map(r => ({
        x: r.year,
        y: metric ? r.tmean_c : cToF(r.tmean_c)
      }));

      const pptPoints = series.map(r => ({
        x: r.year,
        y: metric ? r.ppt_mm : mmToIn(r.ppt_mm)
      }));

      $("tempChartSub").textContent = `${d.minYear}–${d.maxYear}`;
      $("pptChartSub").textContent = `${d.minYear}–${d.maxYear}`;

      drawLineChart(tempCanvas, tempPoints, {
        title: `${monthName} mean temp (${metric ? "°C" : "°F"})`,
        yDigits: 1
      });

      drawLineChart(pptCanvas, pptPoints, {
        title: `${monthName} precip (${metric ? "mm" : "in"})`,
        yDigits: metric ? 0 : 2
      });
    }

    // ---------------- render ----------------
    function renderAll(d) {
      const metric = unitMode === "metric";

      // header name
      if (d.name) {
        $("title").textContent = `Climate: ${d.name}`;
        $("crumbAva").textContent = d.name;
      }
      $("metaAvaId").textContent = `ava_id: ${d.ava_id ?? "—"}`;
      $("metaPeriod").textContent = `period: ${d.minYear}–${d.maxYear}`;

      // KPIs
      const tAll = metric ? d.kpis.tmeanAll : cToF(d.kpis.tmeanAll);
      const tSummer = metric ? d.kpis.tmeanSummer : cToF(d.kpis.tmeanSummer);
      const ppt = metric ? d.kpis.pptMonthly : mmToIn(d.kpis.pptMonthly);

      $("kpi_tmean").textContent = `${fmt(tAll, 1)} ${metric ? "°C" : "°F"}`;
      $("kpi_tsummer").textContent = `${fmt(tSummer, 1)} ${metric ? "°C" : "°F"}`;
      $("kpi_ppt").textContent = `${fmt(ppt, metric ? 0 : 2)} ${metric ? "mm" : "in"}`;
      $("kpi_cov").textContent = `${d.minYear}–${d.maxYear}`;

      $("overviewNote").textContent =
        `Rows: ${d.count.toLocaleString()} monthly records. Period: ${d.minYear}–${d.maxYear}.`;

      // Monthly normals table (static)
      const body = $("monthlyBody");
      body.innerHTML = "";

      for (const r of d.monthly) {
        const m = r.month;

        const tmean = metric ? r.tmean_mean : cToF(r.tmean_mean);
        const tmin  = metric ? r.tmean_min  : cToF(r.tmean_min);
        const tmax  = metric ? r.tmean_max  : cToF(r.tmean_max);

        const pmean = metric ? r.ppt_mean   : mmToIn(r.ppt_mean);
        const pmin  = metric ? r.ppt_min    : mmToIn(r.ppt_min);
        const pmax  = metric ? r.ppt_max    : mmToIn(r.ppt_max);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${MONTHS[m-1]}</td>
          <td>${fmt(tmean, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(tmin, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(tmax, 1)} ${metric ? "°C" : "°F"}</td>
          <td>${fmt(pmean, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
          <td>${fmt(pmin, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
          <td>${fmt(pmax, metric ? 0 : 2)} ${metric ? "mm" : "in"}</td>
        `;
        body.appendChild(tr);
      }

      $("monthlyNote").textContent = "Monthly normals computed by averaging each month across all years.";

      // Charts
      renderCharts(d);
    }

    // ---------------- load ----------------
    async function init() {
      if (!avaId) {
        $("overviewNote").textContent = "No ava_id provided. Go back to the map and click an AVA.";
        $("monthlyNote").textContent = "No AVA selected.";
        return;
      }

      try {
        const res = await fetch("./assets/data/ava_prism_monthly_stats.csv");
        if (!res.ok) throw new Error("CSV fetch failed: " + res.status);

        const text = await res.text();
        const all = parseCsv(text);

        const rows = all.filter(r => String(r.ava_id) === String(avaId));
        if (!rows.length) {
          $("overviewNote").textContent = "No rows found for this ava_id in the CSV.";
          $("monthlyNote").textContent = "Nothing to display.";
          return;
        }

        const derived = computeDerived(rows);
        derived.yearly = computeYearly(derived.parsed);
        derived.monthSeries = computeMonthSeries(derived.parsed);

        window.__derived = derived;

        // wire dropdown once
        $("chartSelect")?.addEventListener("change", () => {
          if (window.__derived) renderCharts(window.__derived);
        });

        renderAll(derived);

      } catch (e) {
        console.warn(e);
        $("overviewNote").textContent = "Failed to load / parse CSV. Check console.";
        $("monthlyNote").textContent = "Failed to load.";
        $("visualNote").textContent = "Failed to load charts.";
      }
    }

    init();
  </script>
</body>
</html>
